@page "/"
@using WeddingSite.Client.Services.Abstractions
@using WeddingSite.Client.Authentication

@inject IDataService DataService
@inject ITokenService TokenService
@inject NavigationManager NavManager
@inject CustomAuthStateProvider AuthStateProvider

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>

<input type="text" placeholder="Passphrase" @bind-value="@passphraseValue" />
<input @onclick="GetToken" type="submit" value="Get Token" />

<hr />

<p>@text</p>

<hr />

<AuthorizeView>
    <Authorized>
        The user is authorized
        <button @onclick="ClearToken">Clear Token</button>
    </Authorized>
    <NotAuthorized>
        The User is not authorized
    </NotAuthorized>
</AuthorizeView>

@code {
    private string passphraseValue = string.Empty;
    private string text = string.Empty;

    private async Task GetToken()
    {
        var currentPassphrase = passphraseValue;
        var result = await DataService.GetAuthTokenAsync(currentPassphrase);

        if (result == currentPassphrase)
        {
            text = "Couldn't find an invitation with that passphrase!";
            return;
        }

        text = result;
        await TokenService.StoreTokenAsync(result);

        this.StateHasChanged();
        AuthStateProvider.RaiseAuthenticationStateChanged();
    }

    private async Task ClearToken()
    {
        await TokenService.ClearTokenAsync();

        this.StateHasChanged();
        AuthStateProvider.RaiseAuthenticationStateChanged();
    }

}