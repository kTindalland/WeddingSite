@page "/"
@using WeddingSite.Client.Services.Abstractions
@using WeddingSite.Client.Authentication

@inject IDataService _dataService
@inject ITokenService _tokenService
@inject NavigationManager _navManager
@inject CustomAuthStateProvider _authStateProvider

@inject ILogger<Index> _logger

<PageTitle>Index</PageTitle>

<h1>Hello, world!</h1>
<p>This is version v0.2.5</p>
<hr />

<input type="text" placeholder="Passphrase" @bind-value="@_passphraseValue" />
<input @onclick="GetToken" type="submit" value="Get Token" />

<hr />

<span style="white-space: pre-line;">@_text</span>

<hr />

<AuthorizeView>
    <Authorized>
        The user is authorized, hello @context.User.Claims.FirstOrDefault(u => u.Type == "guests")?.Value
        <button @onclick="ClearToken">Clear Token</button>
    </Authorized>
    <NotAuthorized>
        The User is not authorized
    </NotAuthorized>
</AuthorizeView>

@code {
    private string _passphraseValue = string.Empty;
    private string _text = string.Empty;

    private async Task GetToken()
    {
        
        
        var currentPassphrase = _passphraseValue;
        _logger.LogInformation("Attempting to get a token using passphrase {Passphrase}", currentPassphrase);
        
        var result = await _dataService.GetAuthTokenAsync(currentPassphrase);

        if (result == currentPassphrase)
        {
            _logger.LogWarning("Passphrase search failed! passphrase: {Passphrase}", currentPassphrase);
            _text = "Couldn't find an invitation with that passphrase!";
            return;
        }
        
        _logger.LogInformation("Got token from passphrase! passphrase: {Passphrase}", currentPassphrase);


        await _tokenService.StoreTokenAsync(result);

        await _authStateProvider.RaiseAuthenticationStateChanged();

        _text = result;
        this.StateHasChanged();
    }

    private async Task ClearToken()
    {
        await _tokenService.ClearTokenAsync();

        
        await _authStateProvider.RaiseAuthenticationStateChanged();
        this.StateHasChanged();
    }

}